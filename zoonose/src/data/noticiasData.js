// zoonose/src/data/noticiasData.js
import { ref } from 'vue'

const noticias = ref([])
const carregando = ref(false)
const erro = ref(null)

const API_URL = 'http://localhost:8080/api/news'

// Fun√ß√£o para obter o token JWT
const getAuthToken = () => {
  return localStorage.getItem('token')
}

// Fun√ß√£o para configurar headers
const getAuthHeaders = () => {
  const token = getAuthToken()
  console.log('üîë Token encontrado:', token ? 'SIM ‚úÖ' : 'N√ÉO ‚ùå')
  
  const headers = {
    'Content-Type': 'application/json',
    'Accept': 'application/json'
  }
  
  if (token) {
    headers['Authorization'] = token.startsWith('Bearer ') ? token : `Bearer ${token}`
    console.log('üì§ Authorization header:', headers['Authorization'].substring(0, 20) + '...')
  } else {
    console.warn('‚ö†Ô∏è Nenhum token encontrado! Voc√™ precisa fazer login primeiro.')
  }
  
  return headers
}

// Fun√ß√£o para detectar se √© campanha ou not√≠cia baseado no conte√∫do
const detectarTipo = (content, title) => {
  if (!content) return 'noticia'
  
  // Se tem campos de campanha, √© campanha
  const temCamposCampanha = /Data In√≠cio:|Data Fim:|Hor√°rio da Campanha:/i.test(content)
  const temTituloCampanha = /campanha|vacina√ß√£o|mutir√£o/i.test(title || '')
  
  return (temCamposCampanha || temTituloCampanha) ? 'campanha' : 'noticia'
}

// Fun√ß√£o para extrair dados de CAMPANHA
const extrairDadosCampanha = (content, title) => {
  const dataInicioMatch = content.match(/Data In√≠cio:\s*(.+?)(?:\n|$)/i)
  const dataFimMatch = content.match(/Data Fim:\s*(.+?)(?:\n|$)/i)
  const horarioMatch = content.match(/Hor√°rio da Campanha:\s*(.+?)(?:\n|$)/i)
  
  return {
    tipo: 'campanha',
    nomeCampanha: title,
    dataInicioCampanha: dataInicioMatch ? dataInicioMatch[1].trim() : '',
    dataFimCampanha: dataFimMatch ? dataFimMatch[1].trim() : '',
    horarioCampanha: horarioMatch ? horarioMatch[1].trim() : '',
    urlImagem: null
  }
}

// Fun√ß√£o para extrair dados de NOT√çCIA
const extrairDadosNoticia = (content, title) => {
  return {
    tipo: 'noticia',
    nomeNoticia: title,
    urlImagemNoticia: null,
    resumo: content
  }
}

// Fun√ß√£o para limpar o conte√∫do de metadados
const limparConteudo = (content) => {
  if (!content) return ''
  
  return content
    .replace(/\n\nData In√≠cio:.*$/gim, '')
    .replace(/\nData Fim:.*$/gim, '')
    .replace(/\nHor√°rio da Campanha:.*$/gim, '')
    .replace(/\n\nData:.*$/gim, '')
    .replace(/\nHor√°rio:.*$/gim, '')
    .replace(/\nLocal:.*$/gim, '')
    .replace(/\nP√∫blico(-alvo)?:.*$/gim, '')
    .replace(/\nContato:.*$/gim, '')
    .replace(/\nInscri√ß√µes:.*$/gim, '')
    .trim()
}

// Mapear backend -> frontend
const mapBackendToFrontend = (backendNews) => {
  const tipo = detectarTipo(backendNews.content, backendNews.title)
  const conteudoLimpo = limparConteudo(backendNews.content)
  
  let dadosEspecificos = {}
  
  if (tipo === 'campanha') {
    dadosEspecificos = extrairDadosCampanha(backendNews.content, backendNews.title)
    dadosEspecificos.urlImagem = backendNews.imageUrl
  } else {
    dadosEspecificos = extrairDadosNoticia(conteudoLimpo, backendNews.title)
    dadosEspecificos.urlImagemNoticia = backendNews.imageUrl
    dadosEspecificos.resumo = conteudoLimpo
  }
  
  return {
    id: backendNews.id,
    tipo: tipo,
    ...dadosEspecificos,
    // Campos comuns
    titulo: backendNews.title, // Mant√©m para compatibilidade
    categoria: tipo === 'campanha' ? 'campanha' : 'geral',
    status: 'ativo',
    autor: backendNews.user?.name || 'Sistema',
    dataPublicacao: backendNews.createdAt
  }
}

// Mapear frontend -> backend
const mapFrontendToBackend = (frontendNews) => {
  let content = ''
  let title = ''
  let imageUrl = ''
  
  if (frontendNews.tipo === 'campanha') {
    title = frontendNews.nomeCampanha
    imageUrl = frontendNews.urlImagem
    
    // Montar conte√∫do da campanha
    content = `Campanha: ${frontendNews.nomeCampanha}`
    if (frontendNews.dataInicioCampanha) {
      content += `\n\nData In√≠cio: ${frontendNews.dataInicioCampanha}`
    }
    if (frontendNews.dataFimCampanha) {
      content += `\nData Fim: ${frontendNews.dataFimCampanha}`
    }
    if (frontendNews.horarioCampanha) {
      content += `\nHor√°rio da Campanha: ${frontendNews.horarioCampanha}`
    }
  } else {
    title = frontendNews.nomeNoticia
    imageUrl = frontendNews.urlImagemNoticia
    content = frontendNews.resumo || ''
  }
  
  return {
    title: title,
    content: content,
    imageUrl: imageUrl || undefined
  }
}

export function useNoticias() {

  const carregarNoticias = async () => {
    carregando.value = true
    erro.value = null
    
    try {
      // GET /news √© p√∫blico, n√£o precisa de token
      const response = await fetch(`${API_URL}?size=100&sort=createdAt,desc`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        mode: 'cors'
      })
      
      if (!response.ok) {
        throw new Error(`Erro HTTP: ${response.status}`)
      }
      
      const data = await response.json()
      noticias.value = data.content.map(mapBackendToFrontend)
      
    } catch (error) {
      erro.value = `Erro ao carregar not√≠cias: ${error.message}`
      console.error('Erro ao carregar not√≠cias:', error)
      noticias.value = []
    } finally {
      carregando.value = false
    }
  }

  // Adicionar nova not√≠cia ou campanha
  const adicionarNoticia = async (noticiaForm) => {
    carregando.value = true
    erro.value = null
    
    try {
      const token = getAuthToken()
      if (!token) {
        throw new Error('Voc√™ precisa estar autenticado como administrador')
      }

      const payload = mapFrontendToBackend(noticiaForm)
      console.log('üì§ Enviando payload:', payload)
      
      const response = await fetch(`${API_URL}/register`, {
        method: 'POST',
        headers: getAuthHeaders(),
        mode: 'cors',
        credentials: 'include',
        body: JSON.stringify(payload)
      })
      
      if (!response.ok) {
        const errorText = await response.text()
        if (response.status === 401) {
          throw new Error('N√£o autorizado. Fa√ßa login novamente.')
        }
        if (response.status === 403) {
          throw new Error('Sem permiss√£o. Apenas administradores podem criar not√≠cias.')
        }
        throw new Error(errorText || 'Erro ao criar item')
      }
      
      const novoItem = await response.json()
      noticias.value.unshift(mapBackendToFrontend(novoItem))
      
      console.log('‚úÖ Not√≠cia criada com sucesso:', novoItem.id)
      
    } catch (error) {
      erro.value = error.message
      console.error('‚ùå Erro ao adicionar:', error)
      throw error
    } finally {
      carregando.value = false
    }
  }

  // ‚ú® EDITAR not√≠cia - AGORA COM INTEGRA√á√ÉO REAL
  const editarNoticia = async (id, noticiaForm) => {
    carregando.value = true
    erro.value = null
    
    try {
      const token = getAuthToken()
      if (!token) {
        throw new Error('Voc√™ precisa estar autenticado como administrador')
      }

      const payload = mapFrontendToBackend(noticiaForm)
      console.log('üìù Editando not√≠cia ID:', id)
      console.log('üì§ Enviando payload:', payload)
      
      const response = await fetch(`${API_URL}/${id}`, {
        method: 'PUT',
        headers: getAuthHeaders(),
        mode: 'cors',
        credentials: 'include',
        body: JSON.stringify(payload)
      })
      
      if (!response.ok) {
        const errorText = await response.text()
        if (response.status === 401) {
          throw new Error('N√£o autorizado. Fa√ßa login novamente.')
        }
        if (response.status === 403) {
          throw new Error('Sem permiss√£o. Apenas administradores podem editar not√≠cias.')
        }
        if (response.status === 404) {
          throw new Error('Not√≠cia n√£o encontrada.')
        }
        throw new Error(errorText || 'Erro ao atualizar item')
      }
      
      const itemAtualizado = await response.json()
      
      // Atualizar na lista local
      const index = noticias.value.findIndex(n => n.id === id)
      if (index !== -1) {
        noticias.value[index] = mapBackendToFrontend(itemAtualizado)
      }
      
      console.log('‚úÖ Not√≠cia atualizada com sucesso:', id)
      
    } catch (error) {
      erro.value = error.message
      console.error('‚ùå Erro ao editar:', error)
      throw error
    } finally {
      carregando.value = false
    }
  }

  // ‚ú® REMOVER not√≠cia - AGORA COM INTEGRA√á√ÉO REAL
  const removerNoticiaPorId = async (id) => {
    carregando.value = true
    erro.value = null
    
    try {
      const token = getAuthToken()
      if (!token) {
        throw new Error('Voc√™ precisa estar autenticado como administrador')
      }

      console.log('üóëÔ∏è Removendo not√≠cia ID:', id)
      
      const response = await fetch(`${API_URL}/${id}`, {
        method: 'DELETE',
        headers: getAuthHeaders(),
        mode: 'cors',
        credentials: 'include'
      })
      
      if (!response.ok) {
        const errorText = await response.text()
        if (response.status === 401) {
          throw new Error('N√£o autorizado. Fa√ßa login novamente.')
        }
        if (response.status === 403) {
          throw new Error('Sem permiss√£o. Apenas administradores podem excluir not√≠cias.')
        }
        if (response.status === 404) {
          throw new Error('Not√≠cia n√£o encontrada.')
        }
        throw new Error(errorText || 'Erro ao excluir item')
      }
      
      // Remover da lista local
      noticias.value = noticias.value.filter(n => n.id !== id)
      
      console.log('‚úÖ Not√≠cia removida com sucesso:', id)
      
    } catch (error) {
      erro.value = error.message
      console.error('‚ùå Erro ao remover:', error)
      throw error
    } finally {
      carregando.value = false
    }
  }

  // Alterar status (apenas localmente - backend n√£o tem este campo)
  const alterarStatusNoticia = async (id, novoStatus) => {
    const index = noticias.value.findIndex(n => n.id === id)
    if (index !== -1) {
      noticias.value[index].status = novoStatus
    }
  }

  // Buscar not√≠cia por ID
  const buscarNoticiaPorId = async (id) => {
    try {
      // GET /news/{id} √© p√∫blico tamb√©m, n√£o precisa de token
      const response = await fetch(`${API_URL}/${id}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        mode: 'cors'
      })
      
      if (!response.ok) {
        console.error(`Erro ao buscar not√≠cia: ${response.status}`)
        return null
      }
      
      const noticia = await response.json()
      return mapBackendToFrontend(noticia)
      
    } catch (error) {
      console.error('Erro ao buscar not√≠cia:', error)
      return null
    }
  }

  // Limpar erro
  const limparErro = () => {
    erro.value = null
  }

  return {
    noticias,
    carregando,
    erro,
    carregarNoticias,
    adicionarNoticia,
    editarNoticia,
    removerNoticiaPorId,
    alterarStatusNoticia,
    buscarNoticiaPorId,
    limparErro
  }
} 